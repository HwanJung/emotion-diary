services:
  reverse-proxy:
    image: caddy:2
    container_name: reverse-proxy
    restart: unless-stopped
    ports: ["80:80","443:443"]
    volumes:
      - ./reverse-proxy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - api
    networks:
      - appnet

  api:
    image: ghcr.io/hwanjung/emotion-diary-api:latest
    container_name: api
    restart: unless-stopped
    env_file: .env.prod
    expose: ["8080"]
    depends_on: [redis]
    networks: [appnet]

  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    env_file: .env.prod
    command: >
      sh -c "redis-server
             --appendonly no
             --protected-mode yes
             --requirepass \"$REDIS_PASSWORD\""
    volumes:
      - redis_data:/data
    healthcheck:
      test: [ "CMD-SHELL", "redis-cli -a \"$REDIS_PASSWORD\" ping" ]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 5s
    networks: [appnet]

networks:
  appnet:

volumes:
  caddy_data:
  caddy_config:
  redis_data:
